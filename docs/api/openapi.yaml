openapi: 3.0.3
info:
  title: AgentHub Router API
  version: 0.1.0
  description: |
    Centralized MCP router with server management, prompt enhancement, and caching.

    ## Features
    - MCP server lifecycle management (install, start, stop, monitor)
    - Unified MCP server access via JSON-RPC proxy
    - Prompt enhancement via Ollama with per-client routing
    - Response caching (L1 memory, L2 semantic)
    - Circuit breaker resilience patterns
    - Real-time monitoring dashboard
    - Audit logging and security alerts

  contact:
    name: AgentHub Project
    url: https://github.com/yourusername/agenthub
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:9090
    description: Local development server

tags:
  - name: Health
    description: Health check and status endpoints
  - name: Servers
    description: MCP server lifecycle management
  - name: MCP Proxy
    description: JSON-RPC proxy to MCP servers
  - name: Enhancement
    description: Prompt enhancement via Ollama
  - name: Circuit Breakers
    description: Resilience pattern management
  - name: Audit
    description: Activity logging and security monitoring
  - name: Configs
    description: Client configuration generators
  - name: Dashboard
    description: Real-time monitoring UI

paths:
  /health:
    get:
      summary: System health check
      description: Returns status of all services including router, Ollama, cache, and MCP servers
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: System is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: healthy
                services:
                  router: up
                  ollama: up
                  cache:
                    status: up
                    hit_rate: 0.82
                    size: 145
                servers:
                  running: 5
                  stopped: 2
                  failed: 0

  /health/{server}:
    get:
      summary: Server-specific health check
      description: Get health status and details for a specific MCP server
      operationId: serverHealth
      tags:
        - Health
      parameters:
        - name: server
          in: path
          required: true
          description: MCP server name (e.g., "context7", "fetch")
          schema:
            type: string
      responses:
        '200':
          description: Server health information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerHealthResponse'
        '404':
          description: Server not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Server registry not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /servers:
    get:
      summary: List all MCP servers
      description: Get list of all configured MCP servers with their current status
      operationId: listServers
      tags:
        - Servers
      responses:
        '200':
          description: List of servers
          content:
            application/json:
              schema:
                type: object
                properties:
                  servers:
                    type: array
                    items:
                      $ref: '#/components/schemas/ServerInfo'
        '503':
          description: Server registry not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /servers/{name}:
    get:
      summary: Get server details
      description: Get detailed configuration and status for a specific MCP server
      operationId: getServer
      tags:
        - Servers
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Server details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerDetail'
        '404':
          description: Server not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      summary: Remove server
      description: Remove a server configuration (must be stopped first)
      operationId: removeServer
      tags:
        - Servers
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Server removed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Server fetch removed"
        '400':
          description: Cannot remove running server
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Server not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /servers/{name}/start:
    post:
      summary: Start server
      description: Start a stopped MCP server
      operationId: startServer
      tags:
        - Servers
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Server started
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  status:
                    type: string
                    example: running
        '400':
          description: Server already running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Failed to start server
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /servers/{name}/stop:
    post:
      summary: Stop server
      description: Stop a running MCP server
      operationId: stopServer
      tags:
        - Servers
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Server stopped
        '400':
          description: Server not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /servers/{name}/restart:
    post:
      summary: Restart server
      description: Restart an MCP server and reset its circuit breaker
      operationId: restartServer
      tags:
        - Servers
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Server restarted
        '500':
          description: Failed to restart
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /servers/install:
    post:
      summary: Install new MCP server
      description: Install and configure a new MCP server from npm package
      operationId: installServer
      tags:
        - Servers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InstallServerRequest'
      responses:
        '200':
          description: Server installed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  name:
                    type: string
                  package:
                    type: string
        '400':
          description: Server already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /mcp/{server}/{path}:
    post:
      summary: Proxy JSON-RPC to MCP server
      description: |
        Forward JSON-RPC requests to MCP servers. The server is auto-started if configured
        with `auto_start: true`. Circuit breaker protects against cascading failures.
      operationId: mcpProxy
      tags:
        - MCP Proxy
      parameters:
        - name: server
          in: path
          required: true
          description: Target MCP server name
          schema:
            type: string
          example: context7
        - name: path
          in: path
          required: true
          description: MCP endpoint path
          schema:
            type: string
          example: tools/call
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JsonRpcRequest'
      responses:
        '200':
          description: JSON-RPC response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JsonRpcResponse'
        '404':
          description: Server not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JsonRpcError'
        '503':
          description: Server unavailable or circuit breaker open
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JsonRpcError'

  /ollama/enhance:
    post:
      summary: Enhance prompt
      description: |
        Enhance a prompt using Ollama. Model selection is based on the X-Client-Name header:
        - `claude-desktop`: deepseek-r1 for structured reasoning
        - `vscode`: qwen3-coder for code-focused responses
        - `raycast`: deepseek-r1 for action-oriented responses
        - `obsidian`: deepseek-r1 with markdown formatting
      operationId: enhancePrompt
      tags:
        - Enhancement
      parameters:
        - name: X-Client-Name
          in: header
          required: false
          description: Client identifier for model routing
          schema:
            type: string
            enum: [claude-desktop, vscode, raycast, obsidian]
          example: claude-desktop
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EnhanceRequest'
      responses:
        '200':
          description: Enhancement result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnhanceResponse'
        '503':
          description: Enhancement service not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /ollama/stats:
    get:
      summary: Enhancement statistics
      description: Get cache stats, hit rates, and Ollama health
      operationId: enhancementStats
      tags:
        - Enhancement
      responses:
        '200':
          description: Enhancement statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  cache:
                    type: object
                    properties:
                      hits:
                        type: integer
                      misses:
                        type: integer
                      size:
                        type: integer
                      hit_rate:
                        type: number
                        format: float
                  ollama_healthy:
                    type: boolean

  /circuit-breakers:
    get:
      summary: List all circuit breakers
      description: Get state and statistics for all circuit breakers
      operationId: listCircuitBreakers
      tags:
        - Circuit Breakers
      responses:
        '200':
          description: Circuit breaker states
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: '#/components/schemas/CircuitBreakerStats'

  /circuit-breakers/{name}/reset:
    post:
      summary: Reset circuit breaker
      description: Force reset a circuit breaker to CLOSED state
      operationId: resetCircuitBreaker
      tags:
        - Circuit Breakers
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Circuit breaker reset
        '404':
          description: Circuit breaker not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /audit/activity:
    get:
      summary: Query activity log
      description: Query HTTP request activity log with filters
      operationId: queryActivity
      tags:
        - Audit
      parameters:
        - name: method
          in: query
          schema:
            type: string
            enum: [GET, POST, PUT, DELETE, PATCH]
        - name: status_min
          in: query
          schema:
            type: integer
        - name: status_max
          in: query
          schema:
            type: integer
        - name: client_id
          in: query
          schema:
            type: string
        - name: request_id
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 1000
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Activity log entries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActivityLogResponse'

    delete:
      summary: Clear activity log
      description: Delete all activity log entries
      operationId: clearActivityLog
      tags:
        - Audit
      responses:
        '200':
          description: Activity log cleared

  /audit/activity/stats:
    get:
      summary: Activity statistics
      description: Get aggregate statistics for activity log
      operationId: activityStats
      tags:
        - Audit
      responses:
        '200':
          description: Activity statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_entries:
                    type: integer
                  by_method:
                    type: object
                    additionalProperties:
                      type: integer
                  by_status:
                    type: object
                    additionalProperties:
                      type: integer

  /security/alerts:
    get:
      summary: Get security alerts
      description: Retrieve recent security alerts with optional severity filter
      operationId: getSecurityAlerts
      tags:
        - Audit
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: severity
          in: query
          schema:
            type: string
            enum: [info, warning, critical]
      responses:
        '200':
          description: Security alerts
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  alerts:
                    type: array
                    items:
                      $ref: '#/components/schemas/SecurityAlert'

  /audit/integrity/verify:
    get:
      summary: Verify audit integrity
      description: Verify audit log integrity using SHA256 checksums
      operationId: verifyAuditIntegrity
      tags:
        - Audit
      responses:
        '200':
          description: Integrity verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrityVerification'

  /configs/claude-desktop:
    get:
      summary: Generate Claude Desktop config
      description: Generate configuration for Claude Desktop integration
      operationId: getClaudeDesktopConfig
      tags:
        - Configs
      responses:
        '200':
          description: Claude Desktop configuration JSON

  /configs/vscode:
    get:
      summary: Generate VS Code config
      description: Generate MCP configuration for VS Code
      operationId: getVscodeConfig
      tags:
        - Configs
      responses:
        '200':
          description: VS Code configuration JSON

  /configs/raycast:
    get:
      summary: Generate Raycast script
      description: Generate shell script for Raycast integration
      operationId: getRaycastScript
      tags:
        - Configs
      responses:
        '200':
          description: Raycast shell script
          content:
            text/plain:
              schema:
                type: string

  /dashboard:
    get:
      summary: Monitoring dashboard
      description: HTMX-based real-time monitoring dashboard
      operationId: dashboard
      tags:
        - Dashboard
      responses:
        '200':
          description: Dashboard HTML

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, down]
        services:
          type: object
          properties:
            router:
              type: string
            ollama:
              type: string
            cache:
              type: object
              properties:
                status:
                  type: string
                hit_rate:
                  type: number
                size:
                  type: integer
        servers:
          type: object
          properties:
            running:
              type: integer
            stopped:
              type: integer
            failed:
              type: integer

    ServerHealthResponse:
      type: object
      properties:
        server:
          type: string
        status:
          type: string
          enum: [running, stopped, failed, starting]
        pid:
          type: integer
          nullable: true
        restart_count:
          type: integer
        last_error:
          type: string
          nullable: true
        circuit_breaker:
          $ref: '#/components/schemas/CircuitBreakerStats'
        config:
          type: object

    ServerInfo:
      type: object
      properties:
        name:
          type: string
        package:
          type: string
        transport:
          type: string
          enum: [stdio, sse, http]
        status:
          type: string
        pid:
          type: integer
          nullable: true
        auto_start:
          type: boolean
        restart_count:
          type: integer
        description:
          type: string

    ServerDetail:
      type: object
      properties:
        name:
          type: string
        config:
          type: object
        process:
          type: object

    InstallServerRequest:
      type: object
      required:
        - package
      properties:
        package:
          type: string
          description: npm package name
          example: "@upstash/context7-mcp"
        name:
          type: string
          description: Server name (auto-generated from package if omitted)
        auto_start:
          type: boolean
          default: false
        description:
          type: string

    JsonRpcRequest:
      type: object
      required:
        - jsonrpc
        - method
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
        method:
          type: string
          example: "tools/call"
        params:
          type: object
        id:
          oneOf:
            - type: string
            - type: integer
            - type: "null"

    JsonRpcResponse:
      type: object
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
        result:
          type: object
        error:
          type: object
          properties:
            code:
              type: integer
            message:
              type: string
            data:
              type: object
        id:
          oneOf:
            - type: string
            - type: integer
            - type: "null"

    JsonRpcError:
      type: object
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
        error:
          type: object
          properties:
            code:
              type: integer
              example: -32603
            message:
              type: string
            data:
              type: object
        id:
          type: "null"

    EnhanceRequest:
      type: object
      required:
        - prompt
      properties:
        prompt:
          type: string
          description: The prompt to enhance
        bypass_cache:
          type: boolean
          default: false
          description: Skip cache lookup

    EnhanceResponse:
      type: object
      properties:
        original:
          type: string
        enhanced:
          type: string
        model:
          type: string
        cached:
          type: boolean
        was_enhanced:
          type: boolean
        error:
          type: string
          nullable: true

    CircuitBreakerStats:
      type: object
      properties:
        state:
          type: string
          enum: [CLOSED, OPEN, HALF_OPEN]
        failure_count:
          type: integer
        success_count:
          type: integer
        last_failure_time:
          type: number
          nullable: true
        last_success_time:
          type: number
          nullable: true

    ActivityLogResponse:
      type: object
      properties:
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer
        entries:
          type: array
          items:
            type: object
            properties:
              request_id:
                type: string
              method:
                type: string
              path:
                type: string
              status:
                type: integer
              duration_ms:
                type: number
              client_id:
                type: string
              client_ip:
                type: string
              timestamp:
                type: string

    SecurityAlert:
      type: object
      properties:
        alert_id:
          type: string
        severity:
          type: string
          enum: [info, warning, critical]
        alert_type:
          type: string
        message:
          type: string
        timestamp:
          type: string
        context:
          type: object

    IntegrityVerification:
      type: object
      properties:
        valid:
          type: boolean
        message:
          type: string
        current_checksum:
          type: object
        previous_checksum:
          type: object

    Error:
      type: object
      properties:
        detail:
          type: string
